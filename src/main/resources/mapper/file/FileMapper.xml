<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.prosync.file.repository.FileMapper">
    <insert id="save" useGeneratedKeys="true" keyProperty="fileId">
        INSERT INTO file(size, path, created_at, file_name)
        VALUES (#{size}, #{path}, #{createdAt}, #{fileName})
    </insert>
    <insert id="saveFileInfo" useGeneratedKeys="true" keyProperty="fileInfoId">
        INSERT INTO file_info(table_name, table_key, file_id)
        VALUES (#{tableName}, #{tableKey}, #{fileId})
    </insert>
    <update id="delete">
        UPDATE file
        SET is_deleted = true
        WHERE file_id=#{fileId} and is_deleted IS NULL;
    </update>
    <select id="findFiles" resultType="com.douzone.prosync.file.entity.File">
        SELECT f.file_id, f.size, f.path, f.created_at, f.file_name, f.is_deleted FROM file_info fi
        JOIN file f ON fi.file_id = f.file_id
        WHERE fi.table_name = #{tableName} AND fi.table_key = #{tableKey}
        AND is_deleted IS NULL;
    </select>
</mapper>